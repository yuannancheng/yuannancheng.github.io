const apiUrl="http://s.safe.360.cn/sapi/api",proxy="https://showtime.applinzi.com/proxy.php";let data=[],scheduleEl=null,scheduleElVan=null,showTimeDelay=15e3,keyframesTime=15,timer=0,changeTimer=null,resizeTimer=null,el=document.getElementById("main"),h1=el.getElementsByTagName("h1")[0],canWidth=0;function getAjax(){return new Promise((e,t)=>{const a=new XMLHttpRequest,n=proxy+"?url="+apiUrl;a.onreadystatechange=function(){4==a.readyState&&200==a.status&&e(JSON.parse(a.responseText))},a.open("GET",n,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send()})}async function handelAjax(){const e=await getAjax();data=e.data.list;let t=[];for(let e=0;e<data.length;e++)"mark_ext"in data[e]&&0===data[e].mark_ext.length&&t.push(data[e]);data=t,t=[];for(let e=0;e<data.length;e++){const a=[" ","｜","—","-","→","←","▷","◁","『","』"],n=["点击查看来源","》》","查看来源","『独白』",">>","▷▷","｜"],l=data[e].link_ext.link_txt,i="^("+a.join("|")+")*[^0-9a-zA-Z⺀-鿿]*(点击查看来源|"+DangerStringFilter(l)+")[^0-9a-zA-Z⺀-鿿]*("+a.join("|")+")*",s="\n?("+a.join("|")+")*[^0-9a-zA-Z⺀-鿿]*(点击查看来源|"+DangerStringFilter(l)+")[^0-9a-zA-Z⺀-鿿]*("+a.join("|")+")*$",r=new RegExp("("+i+"|"+s+")","g");new RegExp(".{0,2}("+n.join("|")+").{0,2}$","g").test(l)&&(data[e].link_ext.link_txt=""),t.push({txt:data[e].txt.replace(r,""),src:data[e].link_ext.link_txt,pic:data[e].pic})}data=t,console.log(data),showInit()}function showInit(){for(let e=0;e<=data.length;e++)e===data.length?setTimeout(()=>{handelAjax()},e*showTimeDelay):setTimeout(()=>{changeShow(e)},e*showTimeDelay)}function changeShow(e){canWidth=window.getComputedStyle?window.getComputedStyle(h1,null).width.split("px")[0]:h1.currentStyle.width.split("px")[0];let t=el.getElementsByClassName("content-wrap")[0];if(t){let a=t.getElementsByClassName("content")[0],n=t.getElementsByClassName("origin")[0];a.innerText=data[e].txt,data[e].src&&data[e].src.length>0?n.innerHTML="—— "+data[e].src:n.innerHTML="",clearInterval(changeTimer),timer=0,scheduleElVan.clearRect(0,0,scheduleEl.width,scheduleEl.height),changeTimer=setInterval(changeSchedule,keyframesTime)}else{let a=document.createElement("canvas");a.className="scheduleCanvas",a.setAttribute("width",canWidth),a.setAttribute("height",1),el.appendChild(a),scheduleEl=a,scheduleElVan=a.getContext("2d"),changeTimer=setInterval(changeSchedule,keyframesTime),(t=document.createElement("div")).className="content-wrap",el.appendChild(t);let n=document.createElement("p");n.innerText=data[e].txt,n.className="content",t.appendChild(n);let l=document.createElement("br");t.appendChild(l);let i=document.createElement("p");i.className="origin",data[e].src&&data[e].src.length>0?i.innerHTML="—— "+data[e].src:i.innerHTML="",t.appendChild(i)}}function changeSchedule(){timer=timer+keyframesTime>=showTimeDelay?showTimeDelay:timer+keyframesTime;let e=Math.floor(scheduleEl.width*timer/showTimeDelay);scheduleElVan.fillStyle="#159957",scheduleElVan.fillRect(0,0,e,1)}function DangerStringFilter(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}handelAjax(),window.onresize=(()=>{resizeTimer||(canWidth=window.getComputedStyle?window.getComputedStyle(h1,null).width.split("px")[0]:h1.currentStyle.width.split("px")[0],scheduleEl.setAttribute("width",canWidth),setTimeout(()=>{resizeTimer=null},50))});